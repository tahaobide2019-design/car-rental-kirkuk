<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø¬Ø² Ù†Ù‚Ù„ | Ø§Ù„Ø­ÙˆØª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #fffbeb; }
        .map-box { height: 180px; border-radius: 1.5rem; border: 3px solid white; z-index: 1; margin-top: 8px; }
        .input-box { width: 100%; padding: 12px; border-radius: 1rem; border: 2px solid #fef08a; font-weight: bold; outline: none; }
    </style>
</head>
<body class="p-4 text-right">
    <div class="max-w-xl mx-auto bg-white rounded-[3rem] shadow-2xl overflow-hidden border-t-[10px] border-yellow-500">
        <div class="bg-yellow-50 p-6 text-center border-b"><h2 id="vT" class="text-xl font-black text-yellow-800">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2></div>
        
        <div class="p-6 space-y-6">
            <input type="text" id="name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†" class="input-box text-lg">

            <div class="bg-green-50 p-4 rounded-3xl">
                <label class="font-black text-green-700 text-sm">ğŸ“ 1. Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ù†Ø·Ù„Ø§Ù‚ (Ù…ÙƒØ§Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„)</label>
                <input type="text" id="sDesc" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‡Ù†Ø§ (Ù…Ø«Ù„Ø§Ù‹: Ø­ÙŠ Ø§Ù„Ù†ØµØ±)" class="input-box mt-2 mb-2 border-green-200">
                <button onclick="getGPS()" class="w-full py-2 bg-green-600 text-white rounded-xl text-[10px] font-bold mb-2">ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ ğŸ›°ï¸</button>
                <div id="mapS" class="map-box"></div>
            </div>

            <div class="bg-blue-50 p-4 rounded-3xl">
                <label class="font-black text-blue-700 text-sm">ğŸ 2. Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ù„ÙŠÙ… (Ù…ÙƒØ§Ù† Ø§Ù„ØªÙØ±ÙŠØº)</label>
                <input type="text" id="eDesc" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‡Ù†Ø§ (Ù…Ø«Ù„Ø§Ù‹: Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©)" class="input-box mt-2 mb-2 border-blue-200">
                <div class="flex gap-2 mb-2">
                    <input type="text" id="searchBox" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†Ø·Ù‚Ø© Ø¨Ø§Ù„Ø®Ø±ÙŠØ·Ø©..." class="flex-1 p-2 border rounded-xl text-xs outline-none">
                    <button onclick="searchLoc()" class="bg-blue-600 text-white px-3 rounded-xl text-xs font-bold">Ø¨Ø­Ø«</button>
                </div>
                <div id="mapE" class="map-box"></div>
            </div>

            <div id="priceCard" class="bg-slate-900 p-5 rounded-3xl text-center text-white hidden">
                <div id="distV" class="text-xs opacity-70"></div>
                <div id="priceV" class="text-2xl font-black text-yellow-400"></div>
            </div>

            <button onclick="submit()" class="w-full bg-yellow-500 text-slate-900 py-4 rounded-2xl font-black text-xl">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨</button>
        </div>
    </div>

    <script>
        let mapS, mapE, mS, mE, distK = 0, pr = 0;
        const u = new URLSearchParams(window.location.search);
        document.getElementById('vT').innerText = "Ø·Ù„Ø¨ " + u.get('vehicle');

        window.onload = function() {
            mapS = L.map('mapS').setView([35.4687, 44.3921], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapS);
            mS = L.marker([35.4687, 44.3921], {draggable:true}).addTo(mapS);

            mapE = L.map('mapE').setView([35.4687, 44.3921], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapE);
            mE = L.marker([35.4687, 44.3921], {draggable:true}).addTo(mapE);

            mS.on('dragend', calc); mE.on('dragend', calc);
        };

        function getGPS() {
            navigator.geolocation.getCurrentPosition(p => {
                const c = [p.coords.latitude, p.coords.longitude];
                mapS.setView(c, 16); mS.setLatLng(c); calc();
            });
        }

        async function searchLoc() {
            const q = document.getElementById('searchBox').value;
            const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
            const d = await r.json();
            if(d.length > 0) {
                const c = [d[0].lat, d[0].lon];
                mapE.setView(c, 15); mE.setLatLng(c); calc();
            }
        }

        function calc() {
            const d = mapS.distance(mS.getLatLng(), mE.getLatLng()) / 1000;
            distK = d.toFixed(1); pr = Math.round(distK * 1500);
            document.getElementById('priceCard').classList.remove('hidden');
            document.getElementById('distV').innerText = "Ø§Ù„Ù…Ø³Ø§ÙØ©: " + distK + " ÙƒÙ…";
            document.getElementById('priceV').innerText = "Ø§Ù„Ø³Ø¹Ø±: " + pr.toLocaleString() + " Ø¯.Ø¹";
        }

        function submit() {
            const n = document.getElementById('name').value;
            const sd = document.getElementById('sDesc').value;
            const ed = document.getElementById('eDesc').value;
            if(!n || !sd || !ed) return alert("Ø§ÙƒÙ…Ù„ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ù„Ø§Ø³Ù…");
            const s = mS.getLatLng(); const e = mE.getLatLng();
            window.location.href = `review.html?service=cargo&car=${encodeURIComponent(u.get('vehicle'))}&name=${encodeURIComponent(n)}&sDesc=${encodeURIComponent(sd)}&eDesc=${encodeURIComponent(ed)}&dist=${distK}&price=${pr}&slat=${s.lat}&slng=${s.lng}&elat=${e.lat}&elng=${e.lng}&emoji=ğŸ“¦&date=${u.get('date')}&time=${u.get('time')}`;
        }
    </script>
</body>
</html>
