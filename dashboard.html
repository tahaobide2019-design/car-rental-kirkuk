var TELEGRAM_TOKEN = '8378544379:AAEcEPTG8tSq1IC7eQPnn_lfgG_DJjaIfiQ';
var CHAT_ID = '9647713225471';

function doPost(e) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    var data = JSON.parse(e.postData.contents);
    var orderId = data.order_id || ('HUT-' + Math.floor(1000 + Math.random() * 9000));
    
    // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ ØµÙˆØ±ØªÙƒ (A:Ø§Ù„ØªØ§Ø±ÙŠØ® | B:Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ | C:Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† | D:Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ | E:Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© | F:Ø§Ù„Ø®Ø¯Ù…Ø© | G:Ø§Ù„ÙˆÙ‚Øª | H:Ø§Ù„Ø­Ø§Ù„Ø© | I:Ø§Ù„Ù…ÙƒØªØ¨)
    sheet.appendRow([
      new Date().toLocaleString(), 
      orderId, 
      data.name, 
      data.phone, 
      data.province, 
      (data.car || data.type), 
      data.time, 
      "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±", 
      ""
    ]);

    sendTelegramNotification("ğŸ‹ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ÙÙŠ " + data.province + " Ù„Ø®Ø¯Ù…Ø© " + (data.car || data.type));
    return ContentService.createTextOutput("Success").setMimeType(ContentService.MimeType.TEXT);
  } catch (err) {
    return ContentService.createTextOutput("Error").setMimeType(ContentService.MimeType.TEXT);
  }
}

function doGet(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var rows = sheet.getDataRange().getValues();
  var action = e.parameter.action;

  if (action == 'getAllOrders') {
    var orders = [];
    for (var i = 1; i < rows.length; i++) {
      orders.push({
        id: rows[i][1],        // ID ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ B (Index 1)
        name: rows[i][2],      // Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ C (Index 2)
        phone: rows[i][3],     // Ø§Ù„Ù‡Ø§ØªÙ ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ D (Index 3)
        province: rows[i][4],  // Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ E (Index 4)
        car: rows[i][5],       // Ø§Ù„Ø®Ø¯Ù…Ø© ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ F (Index 5)
        time: rows[i][6],      // Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ G (Index 6)
        status: rows[i][7],    // Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ H (Index 7)
        claimedBy: rows[i][8]  // Ø§Ù„Ù…ÙƒØªØ¨ ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ I (Index 8)
      });
    }
    return ContentService.createTextOutput(JSON.stringify(orders)).setMimeType(ContentService.MimeType.JSON);
  }

  var id = e.parameter.id;
  for (var i = 1; i < rows.length; i++) {
    if (rows[i][1] == id) { 
      if (action == 'claim') {
        sheet.getRange(i + 1, 8).setValue("ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…");
        sheet.getRange(i + 1, 9).setValue(e.parameter.office);
      } else if (action == 'complete') {
        sheet.getRange(i + 1, 8).setValue("ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² âœ…");
      }
      return ContentService.createTextOutput("Done").setMimeType(ContentService.MimeType.TEXT);
    }
  }
}

function sendTelegramNotification(text) {
  var url = "https://api.telegram.org/bot" + TELEGRAM_TOKEN + "/sendMessage?chat_id=" + CHAT_ID + "&text=" + encodeURIComponent(text);
  UrlFetchApp.fetch(url);
}
