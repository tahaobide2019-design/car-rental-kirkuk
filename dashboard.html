<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø­ÙˆØª Ø§Ù„Ø³Ø±ÙŠØ¹ ğŸ‹ğŸ”Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f1f5f9; }
        .glass-card { background: white; border: 1px solid #e2e8f0; transition: all 0.2s ease; }
        .tab-active { color: #002349; border-bottom: 4px solid #D4AF37; font-weight: 900; }
        .new-order-pulse { animation: shadow-pulse 1s infinite; }
        @keyframes shadow-pulse { 0% { box-shadow: 0 0 0 0px rgba(212, 175, 55, 0.4); } 100% { box-shadow: 0 0 0 20px rgba(212, 175, 55, 0); } }
    </style>
</head>
<body class="text-slate-800 pb-24">

    <audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>

    <nav class="sticky top-0 z-50 bg-[#002349] text-white px-6 py-4 flex justify-between items-center shadow-xl">
        <div>
            <h1 class="text-xl font-black italic">HUTA <span class="text-[#D4AF37]">RADAR</span></h1>
            <p id="navOfficeInfo" class="text-[9px] text-blue-200 font-bold uppercase"></p>
        </div>
        <div class="flex items-center gap-3">
            <span id="syncStatus" class="w-3 h-3 bg-green-500 rounded-full animate-ping"></span>
            <button onclick="logout()" class="bg-red-500/20 text-red-400 text-[10px] font-black px-4 py-2 rounded-lg border border-red-500/30">Ø®Ø±ÙˆØ¬</button>
        </div>
    </nav>

    <div class="flex bg-white border-b border-slate-200 sticky top-[68px] z-40 shadow-sm">
        <button onclick="switchTab('new')" id="tabNew" class="flex-1 py-4 text-sm font-black text-slate-400 transition-all tab-active uppercase">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© âš¡</button>
        <button onclick="switchTab('mine')" id="tabMine" class="flex-1 py-4 text-sm font-black text-slate-400 transition-all uppercase">Ø·Ù„Ø¨Ø§ØªÙŠ ğŸ“¦</button>
    </div>

    <main class="p-4 max-w-2xl mx-auto space-y-4" id="mainContainer">
        <div class="text-center py-20 text-slate-400 italic">Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø§Ø¯Ø§Ø±...</div>
    </main>

    <script>
        // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„ÙØ¹Ø§Ù„
        const scriptURL = "https://script.google.com/macros/s/AKfycby-n4RGZSmkxBI_gmsOIF8sygwGJAXH-l4yvP15EpL8NdcKyZa4M_bQCygy_Ki2nW3IbQ/exec";
        const officeData = JSON.parse(localStorage.getItem('whale_office_data'));
        let currentTab = 'new';
        let lastOrderCount = 0;

        if(!officeData) window.location.href = 'login.html';
        document.getElementById('navOfficeInfo').innerText = `Ù…ÙƒØªØ¨ ${officeData.name} | ${officeData.city}`;

        async function fetchSmartRadar() {
            try {
                document.getElementById('syncStatus').classList.replace('bg-green-500', 'bg-blue-500');
                const res = await fetch(`${scriptURL}?action=getAllOrders&t=${Date.now()}`);
                const data = await res.json();
                
                // ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù…Ù†Ø·Ù‚Ø©
                const newOrders = data.filter(o => o.province === officeData.city && o.status === "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±");
                
                // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¥Ø°Ø§ Ø¯Ø®Ù„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø±Ø§Ø¯Ø§Ø± [cite: 2026-01-29]
                if (newOrders.length > lastOrderCount && currentTab === 'new') {
                    playAlert();
                }
                lastOrderCount = newOrders.length;
                
                renderOrders(data);
                document.getElementById('syncStatus').classList.replace('bg-blue-500', 'bg-green-500');
            } catch(e) { console.error("Sync Error"); }
        }

        function playAlert() {
            const sound = document.getElementById('alertSound');
            sound.volume = 1.0;
            sound.play().catch(e => console.log("Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø£ÙˆÙ„ Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ØµÙˆØª"));
        }

        function renderOrders(data) {
            const container = document.getElementById('mainContainer');
            let filtered = (currentTab === 'new') 
                ? data.filter(o => o.province === officeData.city && o.status === "Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±")
                : data.filter(o => o.claimedBy === officeData.name);

            if(filtered.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-slate-400 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ âš“</div>`;
                return;
            }

            container.innerHTML = filtered.map(o => `
                <div class="glass-card p-6 rounded-[2rem] shadow-lg border-r-[8px] ${currentTab === 'new' ? 'border-[#D4AF37] new-order-pulse' : 'border-blue-600'}">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-[10px] font-black bg-slate-100 px-2 py-1 rounded-md text-slate-500 mb-1 inline-block italic">${o.id}</span>
                            <h3 class="text-xl font-black text-[#002349] leading-tight">${o.car}</h3>
                            <p class="text-slate-500 text-xs font-bold mt-1"><i class="fas fa-map-pin text-red-500"></i> ${o.province}</p>
                        </div>
                        <div class="text-left font-black text-blue-700 text-xl">${o.price} <span class="text-[9px]">Ø¯.Ø¹</span></div>
                    </div>

                    ${currentTab === 'new' ? `
                        <div class="bg-blue-50 p-4 rounded-2xl mb-4 border border-blue-100">
                            <p class="text-xs font-black text-blue-900">ğŸ‘¤ Ø§Ù„Ø²Ø¨ÙˆÙ†: ${o.name}</p>
                        </div>
                        <button onclick="updateStatus('${o.id}', 'claim')" class="w-full bg-[#002349] text-[#D4AF37] py-5 rounded-2xl font-black text-sm shadow-xl hover:brightness-125 active:scale-95 transition-all">Ø¥Ù‚ØªÙ†Ø§Øµ Ø§Ù„Ø·Ù„Ø¨ÙŠØ© Ø§Ù„Ø¢Ù† âš¡</button>
                    ` : `
                        <div class="bg-slate-50 p-4 rounded-2xl mb-4 space-y-3">
                            <a href="tel:${o.phone}" class="flex items-center justify-center gap-3 w-full bg-green-600 text-white py-4 rounded-xl font-black shadow-lg">Ø¥ØªØµØ§Ù„ Ø¨Ø§Ù„Ø²Ø¨ÙˆÙ† <i class="fas fa-phone-flip animate-shake"></i></a>
                            <a href="https://www.google.com/maps/search/${encodeURIComponent(o.province + ' ' + o.name)}" target="_blank" class="flex items-center justify-center gap-3 w-full bg-slate-800 text-white py-3 rounded-xl font-black text-[10px]">Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø²Ø¨ÙˆÙ† <i class="fas fa-location-arrow"></i></a>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="updateStatus('${o.id}', 'complete')" class="bg-blue-600 text-white py-4 rounded-xl font-black text-xs shadow-md">ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² âœ…</button>
                            <button onclick="updateStatus('${o.id}', 'requestCancel')" class="bg-red-50 text-red-500 py-4 rounded-xl font-black text-xs border border-red-100">Ø¥Ù„ØºØ§Ø¡ âŒ</button>
                        </div>
                    `}
                </div>
            `).join('');
        }

        async function updateStatus(id, action) {
            const url = `${scriptURL}?action=${action}&id=${id}&office=${encodeURIComponent(officeData.name)}`;
            await fetch(url);
            fetchSmartRadar();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('button[id^="tab"]').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(tab === 'new' ? 'tabNew' : 'tabMine').classList.add('tab-active');
            fetchSmartRadar();
        }

        function logout() { localStorage.clear(); window.location.href = 'login.html'; }
        
        // Ø³Ø±Ø¹Ø© Ø§Ù„Ø±Ø§Ø¯Ø§Ø±: ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 5 Ø«ÙˆØ§Ù†Ù Ù„Ø§Ù‚ØªÙ†Ø§Øµ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¬Ù…ÙŠØ¹ [cite: 2026-01-29]
        setInterval(fetchSmartRadar, 5000);
        fetchSmartRadar();
    </script>
</body>
</html>
