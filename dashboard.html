<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­ÙˆØª Ø§Ù„Ù…ØªØ·ÙˆØ± ğŸ‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        .pulse-border { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); } }
    </style>
</head>
<body class="bg-slate-100 font-['Tajawal'] min-h-screen">

    <div id="loginScreen" class="fixed inset-0 bg-[#002349] z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-[2.5rem] max-w-sm w-full text-center shadow-2xl">
            <h2 class="text-2xl font-black text-[#002349] mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨ ğŸ‹</h2>
            <input type="text" id="regOfficeName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØªØ¨" class="w-full p-4 mb-4 border-2 border-slate-100 rounded-2xl font-bold outline-none focus:border-[#D4AF37]">
            <select id="regCity" class="w-full p-4 mb-6 border-2 border-slate-100 rounded-2xl font-bold outline-none focus:border-[#D4AF37]">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</option>
                <option value="ÙƒØ±ÙƒÙˆÙƒ">ÙƒØ±ÙƒÙˆÙƒ</option>
                <option value="Ø¨ØºØ¯Ø§Ø¯">Ø¨ØºØ¯Ø§Ø¯</option>
                <option value="Ø£Ø±Ø¨ÙŠÙ„">Ø£Ø±Ø¨ÙŠÙ„</option>
                <option value="Ø§Ù„Ù…ÙˆØµÙ„">Ø§Ù„Ù…ÙˆØµÙ„</option>
                <option value="Ø§Ù„Ø¨ØµØ±Ø©">Ø§Ù„Ø¨ØµØ±Ø©</option>
            </select>
            <button onclick="saveProfile()" class="w-full bg-[#002349] text-[#D4AF37] py-4 rounded-2xl font-black shadow-lg">Ø­ÙØ¸ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div class="max-w-4xl mx-auto p-4">
        <header class="bg-[#002349] text-white p-8 rounded-[2.5rem] mb-6 shadow-2xl flex flex-col md:flex-row justify-between items-center gap-4 relative overflow-hidden">
            <div class="z-10 text-center md:text-right">
                <h1 class="text-2xl font-black">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙƒØ§ØªØ¨ Ø§Ù„Ø°ÙƒÙŠØ© ğŸ‹</h1>
                <p id="profileInfo" class="text-[#D4AF37] font-bold italic">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</p>
            </div>
            <div class="z-10 flex gap-2">
                <button onclick="clearProfile()" class="text-[10px] bg-red-900/50 px-3 py-1 rounded-lg">ØªØºÙŠÙŠØ± Ø§Ù„Ù…ÙƒØªØ¨</button>
                <div id="statusIndicator" class="flex items-center gap-2 bg-green-500/20 px-4 py-2 rounded-full border border-green-500/50">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-ping"></span>
                    <span class="text-xs font-bold uppercase">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</span>
                </div>
            </div>
        </header>

        <div id="ordersContainer" class="grid gap-4">
            </div>
    </div>

    <audio id="alertSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzcDuYDz7t225v-3CoWzJJfoOgW8CEozpx16I7oLG7UIoxZwxOj3xsamdmQIb4Icsphgg/exec";
        let lastOrdersCount = 0;
        let myCity = "";
        let myOffice = "";

        // 1. ÙØ­Øµ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
        window.onload = () => {
            myCity = localStorage.getItem('huta_city');
            myOffice = localStorage.getItem('huta_office');

            if (!myCity || !myOffice) {
                document.getElementById('loginScreen').classList.remove('hidden');
            } else {
                startSystem();
            }
        };

        function saveProfile() {
            const office = document.getElementById('regOfficeName').value.trim();
            const city = document.getElementById('regCity').value;
            if (office && city) {
                localStorage.setItem('huta_office', office);
                localStorage.setItem('huta_city', city);
                location.reload();
            } else { alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
        }

        function clearProfile() {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØºÙŠÙŠØ± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙƒØªØ¨ØŸ")){
                localStorage.clear();
                location.reload();
            }
        }

        function startSystem() {
            document.getElementById('profileInfo').innerText = `Ù…ÙƒØªØ¨: ${myOffice} | Ù…Ø­Ø§ÙØ¸Ø©: ${myCity}`;
            loadOrders(); // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ Ù…Ø±Ø©
            setInterval(loadOrders, 30000); // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
        }

        async function loadOrders() {
            try {
                const response = await fetch(`${scriptURL}?action=getOrders&city=${encodeURIComponent(myCity)}`);
                const orders = await response.json();

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„ØµÙˆØª
                if (orders.length > lastOrdersCount) {
                    playAlert();
                }
                lastOrdersCount = orders.length;

                renderOrders(orders);
            } catch (e) { console.error("Error fetching data"); }
        }

        function renderOrders(orders) {
            let html = '';
            if (orders.length === 0) {
                html = '<div class="bg-white p-12 rounded-[2.5rem] text-center shadow-sm border-2 border-dashed border-slate-200"><p class="text-gray-400 font-bold italic text-lg">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ ${myCity} Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ±Ø§Ù‚Ø¨ Ø§Ù„Ø¢Ù†...</p></div>';
            } else {
                orders.forEach(order => {
                    html += `
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-md flex flex-col md:flex-row justify-between items-center gap-6 border-r-8 border-[#002349] pulse-border">
                        <div class="text-center md:text-right">
                            <h3 class="font-black text-xl text-slate-800">${order.car}</h3>
                            <p class="text-slate-500 font-bold">Ø§Ù„Ø²Ø¨ÙˆÙ†: ${order.name} | Ø§Ù„Ù…ÙˆØ¹Ø¯: ${order.time}</p>
                            <span class="inline-block mt-2 bg-blue-50 text-[#002349] px-3 py-1 rounded-lg text-xs font-black italic">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­</span>
                        </div>
                        <button onclick="claim('${order.id}')" class="w-full md:w-auto bg-[#002349] text-[#D4AF37] px-10 py-4 rounded-2xl font-black text-lg hover:bg-slate-800 transition-all shadow-lg active:scale-95">Ø§Ø³ØªÙ„Ø§Ù… ÙˆØªØ£ÙƒÙŠØ¯ âœ…</button>
                    </div>`;
                });
            }
            document.getElementById('ordersContainer').innerHTML = html;
        }

        function playAlert() {
            const sound = document.getElementById('alertSound');
            sound.play().catch(e => console.log("ÙŠØ¬Ø¨ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ØµÙØ­Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª"));
            // Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ¯Ø¹Ù… Ø°Ù„Ùƒ
            if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 500]);
        }

        async function claim(id) {
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŸ`)) return;

            const response = await fetch(`${scriptURL}?action=claim&id=${id}&office=${encodeURIComponent(myOffice)}`);
            const result = await response.text();
            
            if (result === "ØªÙ… Ø¨Ù†Ø¬Ø§Ø­") {
                alert("ØªÙ… Ø­Ø¬Ø² Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ø³Ù… " + myOffice);
                loadOrders();
            } else {
                alert(result);
            }
        }
    </script>
</body>
</html>
